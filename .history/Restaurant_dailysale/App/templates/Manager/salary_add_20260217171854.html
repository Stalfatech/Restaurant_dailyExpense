{% extends "base.html" %}
{% load static %}
{% block 'content' %}

<div class="container mt-5">
<div class="card shadow-lg border-0 rounded-4">

<div class="card-header bg-dark text-white py-3">
<h4 class="mb-0">
<i class="bi bi-cash-stack me-2"></i> Add Salary
</h4>
<div>
<button class="btn btn-light btn-sm" onclick="history.back()">
<i class="bi bi-arrow-left"></i> Back
</button>
</div>
</div>

<div class="card-body p-4">

<form method="POST">
{% csrf_token %}

<div class="row g-3">

<!-- Staff -->
<div class="col-md-6">
<label class="form-label fw-semibold">Staff Name *</label>
<select name="staff" id="staff_select" class="form-select" required>
<option value="">Select Staff</option>
{% for staff in staffs %}
<option value="{{ staff.id }}" data-salary-type="{{ staff.salary_type }}">
{{ staff.name }}
</option>
{% endfor %}
</select>
</div>

<!-- Salary Type -->
<div class="col-md-6">
<label class="form-label fw-semibold">Salary Type</label>
<input type="text" id="salary_type_display" class="form-control bg-light" readonly>
</div>

<!-- Month -->
<div class="col-md-6">
<label class="form-label fw-semibold">Salary Month *</label>
<select name="salary_month" id="salary_month" class="form-select" required>
<option value="">Select Month</option>
{% for m,v in month_choices %}
<option value="{{ m }}">{{ v }}</option>
{% endfor %}
</select>
</div>

<!-- Year -->
<div class="col-md-6">
<label class="form-label fw-semibold">Salary Year *</label>
<select name="salary_year" id="salary_year" class="form-select" required>
<option value="">Select Year</option>
{% for year in years %}
<option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
{% endfor %}
</select>
</div>

<!-- Salary Amount -->
<div class="col-md-6">
<label class="form-label fw-semibold">Salary Amount *</label>
<input type="number" step="0.01" name="salary_amount" id="salary_amount" class="form-control" required>
</div>

<!-- Need Advance -->
<div class="col-md-6">
<label class="form-label fw-semibold">Do you need advance of this month?</label>
<select name="need_advance" id="needAdvance" class="form-select" onchange="toggleAdvanceField()">
<option value="no" selected>No</option>
<option value="yes">Yes</option>
</select>
</div>

<!-- Salary Advance -->
<div class="col-md-6 d-none" id="advanceField">
<label class="form-label fw-semibold">Salary Advance</label>
<input type="number" step="0.01" name="salary_advance" id="salary_advance" value="0" class="form-control">
</div>

<!-- Paid Amount -->
<div class="col-md-6">
<label class="form-label fw-semibold">Paid Amount</label>
<input type="number" step="0.01" name="paid_amount" id="paid_amount" value="0" class="form-control">
</div>

<!-- Payment Date -->
<div class="col-md-6">
<label class="form-label fw-semibold">Payment Date *</label>
<input type="date" name="payment_date" class="form-control" required>
</div>

<!-- Payment Mode -->
<div class="col-md-6">
<label class="form-label fw-semibold">Payment Mode *</label>
<select name="payment_mode" class="form-select" required>
<option value="">Select Mode</option>
<option value="Cash">Cash</option>
<option value="Bank">Bank</option>
</select>
</div>

<!-- Need next month advance -->
<div class="col-md-6">
<label class="form-label fw-semibold">Need Next Month Advance?</label>
<select id="needNextAdvance" class="form-select" onchange="toggleNextMonthAdvance()">
<option value="no" selected>No</option>
<option value="yes">Yes</option>
</select>
</div>

<!-- Next month advance -->
<div class="col-md-6 d-none" id="nextMonthAdvanceField">
<label class="form-label fw-semibold">Next Month Advance Salary</label>
<input type="number" step="0.01" name="next_month_advance" id="next_month_advance" value="0" class="form-control">
</div>

<!-- Balance Preview -->
<div class="col-md-6">
<label class="form-label fw-semibold">Balance (Preview)</label>
<input type="text" id="balance_preview" class="form-control bg-light" readonly>
</div>

<!-- Previous balance -->
<div class="col-md-6">
<label class="form-label fw-semibold">Previous Month Balance</label>
<input type="text" id="previous_balance" class="form-control bg-light" readonly>
</div>

<!-- Already bought -->
<div class="col-md-6">
<label class="form-label fw-semibold">Already Bought Next Month Advance</label>
<input type="text" id="previous_next_month_advance" class="form-control bg-light" readonly>
</div>

</div>

<div class="text-end mt-4">
<button type="submit" class="btn btn-dark px-4 rounded-3">
<i class="bi bi-save me-1"></i> Save Salary
</button>
</div>

</form>

</div>
</div>
</div>


<script>
const staffSelect = document.getElementById("staff_select");
const salaryTypeDisplay = document.getElementById("salary_type_display");

const salaryInput  = document.getElementById("salary_amount");
const advanceInput = document.getElementById("salary_advance");
const paidInput    = document.getElementById("paid_amount");

const prevBalanceEl = document.getElementById("previous_balance");
const prevAdvanceEl = document.getElementById("previous_next_month_advance");

const balancePreview = document.getElementById("balance_preview");

const monthSelect = document.getElementById("salary_month");
const yearSelect  = document.getElementById("salary_year");

const nextMonthAdvanceInput = document.getElementById("next_month_advance");


// show salary type
staffSelect.addEventListener("change", function () {
    const selected = this.options[this.selectedIndex];
    salaryTypeDisplay.value = selected.getAttribute("data-salary-type") || "";
    fetchPreviousSalaryData();
});


// main calculation (your rule)
function calculateBalance() {

    const salary  = parseFloat(salaryInput.value) || 0;
    const advance = parseFloat(advanceInput.value) || 0;
    const paid    = parseFloat(paidInput.value) || 0;

    const previousBalance =
        parseFloat(prevBalanceEl.value) || 0;

    const alreadyBought =
        parseFloat(prevAdvanceEl.value) || 0;

    const effectivePrevious =
        previousBalance - alreadyBought;

    const finalBalance =
        (salary - (advance + paid)) + effectivePrevious;

    balancePreview.value = finalBalance.toFixed(2);
}


// inputs
salaryInput.addEventListener("input", calculateBalance);
advanceInput.addEventListener("input", calculateBalance);
paidInput.addEventListener("input", calculateBalance);


// toggle current advance
function toggleAdvanceField() {

    const dropdown = document.getElementById("needAdvance");
    const field = document.getElementById("advanceField");

    if (dropdown.value === "yes") {
        field.classList.remove("d-none");
        advanceInput.value = "";
        advanceInput.focus();
    } else {
        field.classList.add("d-none");
        advanceInput.value = 0;
        calculateBalance();
    }
}


// toggle next month advance
function toggleNextMonthAdvance() {

    const dropdown = document.getElementById("needNextAdvance");
    const field = document.getElementById("nextMonthAdvanceField");

    if (dropdown.value === "yes") {
        field.classList.remove("d-none");
        nextMonthAdvanceInput.value = "";
        nextMonthAdvanceInput.focus();
    } else {
        field.classList.add("d-none");
        nextMonthAdvanceInput.value = 0;
    }
}


// fetch previous salary data
function fetchPreviousSalaryData() {

    const staff_id = staffSelect.value;
    const month = monthSelect.value;
    const year  = yearSelect.value;

    if (!staff_id || !month || !year) return;

    const url = `/get_previous_salary_data/?staff_id=${staff_id}&salary_month=${month}&salary_year=${year}`;

    fetch(url)
        .then(r => r.json())
        .then(data => {

            prevBalanceEl.value = data.previous_balance || "0.00";
            prevAdvanceEl.value = data.previous_next_month_advance || "0.00";

            if (document.getElementById("needNextAdvance").value === "no") {
                nextMonthAdvanceInput.value =
                    data.previous_next_month_advance || 0;
            }

            calculateBalance();
        });
}


monthSelect.addEventListener("change", fetchPreviousSalaryData);
yearSelect.addEventListener("change", fetchPreviousSalaryData);


document.addEventListener("DOMContentLoaded", function () {
    toggleAdvanceField();
    calculateBalance();
});
</script>

{% endblock %}


