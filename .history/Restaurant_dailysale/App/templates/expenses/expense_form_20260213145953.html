{% extends "base.html" %}
{% block 'content' %}

<h3>Expense Form</h3>

<form method="POST" enctype="multipart/form-data" class="card p-4 shadow">
    {% csrf_token %}

    <div class="mb-3">
        <label class="form-label">Date <span class="text-danger">*</span></label>
        {{ form.date }}
        <div class="text-danger">{{ form.date.errors }}</div>
    </div>

    {% if user_type == 0 %}
    <div class="mb-3">
        <label class="form-label">Branch <span class="text-danger">*</span></label>
        {{ form.branch }}
        <div class="text-danger">{{ form.branch.errors }}</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Status</label>
        {{ form.status }}
        <div class="text-danger">{{ form.status.errors }}</div>
    </div>
    {% endif %}

    <!-- Rest of fields -->
    <div class="mb-3">
        <label class="form-label">Category <span class="text-danger">*</span></label>
        {{ form.category }}
        <div class="text-danger">{{ form.category.errors }}</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Supplier <span class="text-danger">*</span></label>
        {{ form.supplier }}
        <div class="text-danger">{{ form.supplier.errors }}</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Product <span class="text-danger">*</span></label>
        {{ form.product }}
        <div class="text-danger">{{ form.product.errors }}</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Quantity <span class="text-danger"></span></label>
        {{ form.quantity }}
        <div class="text-danger">{{ form.quantity.errors }}</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Purchase Type <span class="text-danger">*</span></label>
        {{ form.purchase_type }}
        <div class="text-danger">{{ form.purchase_type.errors }}</div>
    </div>

   
    <div class="mb-3">
        <label class="form-label">Invoice (PDF/Image) <span class="text-danger">*</span></label>
        {{ form.invoice }}
        <div class="text-danger">{{ form.invoice.errors }}</div>
    </div>
     <div class="mb-3">
        <label class="form-label">Amount <span class="text-danger"></span></label>
        {{ form.amount }}
        <div class="text-danger">{{ form.amount.errors }}</div>
    </div>
    <div id="invoice-preview" style="display:none;" class="card p-3 mt-3">

    <h5>Extracted Invoice Details</h5>

    <div class="mb-2">
        <label>Invoice Number</label>
        <input type="text" id="invoice_number" class="form-control">
    </div>

    <div class="mb-2">
        <label>Invoice Date</label>
        <input type="text" id="invoice_date" class="form-control">
    </div>

    <div class="mb-2">
        <label>Phone</label>
        <input type="text" id="phone" class="form-control">
    </div>

    <div class="mb-2">
        <label>Subtotal</label>
        <input type="text" id="subtotal" class="form-control">
    </div>

    <div class="mb-2">
        <label>Tax</label>
        <input type="text" id="tax" class="form-control">
    </div>

    <div class="mb-2">
        <label>Grand Total</label>
        <input type="text" id="grand_total" class="form-control">
    </div>

    <button type="button" id="previewBtn" class="btn btn-info mt-2">Preview</button>
</div>



    <div class="mb-3">
        <label class="form-label">Description</label>
        {{ form.description }}
    </div>

    <button type="submit" class="btn btn-success">Save Expense</button>
    <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>

</form>
<script>
document.addEventListener("DOMContentLoaded", function () {

    const invoiceInput = document.querySelector("input[name='invoice']");

    invoiceInput.addEventListener("change", function () {

        let formData = new FormData();
        formData.append("invoice", this.files[0]);

        fetch("{% url 'extract_invoice_data' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {

            document.getElementById("invoice-preview").style.display = "block";

            document.getElementById("invoice_number").value = data.invoice_number || "";
            document.getElementById("invoice_date").value = data.invoice_date || "";
            document.getElementById("phone").value = data.phone || "";
            document.getElementById("subtotal").value = data.subtotal || "";
            document.getElementById("tax").value = data.tax || "";
            document.getElementById("grand_total").value = data.grand_total || "";

            // Also autofill expense amount
            if (data.grand_total) {
                document.querySelector("input[name='amount']").value = data.grand_total;
            }

        });

    });

});
</script>


{% endblock %}