{% extends "base.html" %}
{% block 'content' %}

<h3>Expense Form</h3>

<form method="POST" enctype="multipart/form-data" class="card p-4 shadow">
    {% csrf_token %}

    <div class="mb-3">
        <label class="form-label">Date <span class="text-danger">*</span></label>
        {{ form.date }}
        <div class="text-danger">{{ form.date.errors }}</div>
    </div>

    {% if user_type == 0 %}
    <div class="mb-3">
        <label class="form-label">Branch <span class="text-danger">*</span></label>
        {{ form.branch }}
        <div class="text-danger">{{ form.branch.errors }}</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Status</label>
        {{ form.status }}
        <div class="text-danger">{{ form.status.errors }}</div>
    </div>
    {% endif %}

    <div class="mb-3">
        <label class="form-label">Category <span class="text-danger">*</span></label>
        {{ form.category }}
        <div class="text-danger">{{ form.category.errors }}</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Supplier <span class="text-danger">*</span></label>
        {{ form.supplier }}
        <div class="text-danger">{{ form.supplier.errors }}</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Product <span class="text-danger">*</span></label>
        {{ form.product }}
        <div class="text-danger">{{ form.product.errors }}</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Quantity</label>
        {{ form.quantity }}
        <div class="text-danger">{{ form.quantity.errors }}</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Purchase Type <span class="text-danger">*</span></label>
        {{ form.purchase_type }}
        <div class="text-danger">{{ form.purchase_type.errors }}</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Invoice (PDF/Image) <span class="text-danger">*</span></label>
        {{ form.invoice }}
        <div class="text-danger">{{ form.invoice.errors }}</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Amount</label>
        {{ form.amount }}
        <div class="text-danger">{{ form.amount.errors }}</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Description</label>
        {{ form.description }}
    </div>

    <button type="submit" class="btn btn-success">Save Expense</button>
    <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>

</form>
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.split("=")[1]);
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie("csrftoken");

document.addEventListener("DOMContentLoaded", function() {
    const invoiceInput = document.getElementById("invoiceInput");
    const amountField = document.getElementById("amountField");

    if (!invoiceInput || !amountField) return;

    invoiceInput.addEventListener("change", function() {
        if (!this.files.length) return;

        const formData = new FormData();
        formData.append("invoice", this.files[0]);

        fetch("{% url 'extract_invoice_amount' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log("OCR Response:", data);
            if (data.amount) {
                amountField.value = data.amount;  // full line text
            } else {
                amountField.value = "";
                alert("Could not detect total amount from invoice.");
            }
        })
        .catch(error => {
            console.error("Error fetching invoice amount:", error);
            alert("Error extracting amount. Check console for details.");
        });
    });
});
</script>


{% endblock %}
