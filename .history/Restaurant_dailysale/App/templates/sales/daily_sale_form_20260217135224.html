{% extends "base.html" %}
{% load static %}
{% block 'content' %}

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>{{ page_title }}</h4>
        <a href="{% url 'daily_sales_dashboard' %}" class="btn btn-secondary">← Back to Sales</a>
    </div>

    <div class="card shadow">
        <div class="card-body">

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <form method="POST" id="salesForm">
                {% csrf_token %}

                <!-- ================= BASIC DETAILS ================= -->
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Date *</label>
                        {{ form.date }}
                        <div class="text-danger">{{ form.date.errors }}</div>
                    </div>

                    {% if user_type == 0 %}
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Branch *</label>
                        {{ form.branch }}
                        <div class="text-danger">{{ form.branch.errors }}</div>
                    </div>
                    {% endif %}

                    <div class="col-md-3 mb-3">
                        <label class="form-label">POS Type</label>
                        {{ form.pos_type }}
                        <div class="text-danger">{{ form.pos_type.errors }}</div>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label">POS Amount</label>
                        {{ form.pos_amount }}
                        <div class="text-danger">{{ form.pos_amount.errors }}</div>
                    </div>
                </div>

                <hr>

                <!-- ================= MEAL ITEMS ================= -->
                <h5>Meal Items</h5>
                {{ item_formset.management_form }}

                <table class="table" id="mealTable">
                    <thead>
                        <tr>
                            <th>Meal <span class="text-danger mandatory-star">*</span></th>
                            <th>Item <span class="text-danger mandatory-star">*</span></th>
                            <th>Amount <span class="text-danger mandatory-star">*</span></th>
                            <th width="80">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in item_formset %}
                        <tr class="meal-form">
                            {{ form.id }}
                            <td>{{ form.meal_type }}<div class="text-danger small">{{ form.meal_type.errors|join:", " }}</div></td>
                            <td>{{ form.item_name }}<div class="text-danger small">{{ form.item_name.errors|join:", " }}</div></td>
                            <td>{{ form.amount }}<div class="text-danger small">{{ form.amount.errors|join:", " }}</div></td>
                            <td>{{ form.DELETE }}<button type="button" class="btn btn-sm btn-danger remove-row">❌</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <button type="button" class="btn btn-sm btn-primary" id="addMeal">+ Add Meal</button>

                <hr>

                <!-- ================= DELIVERY ================= -->
                <h5>Delivery Platforms</h5>
                {{ delivery_formset.management_form }}

                <table class="table" id="deliveryTable">
                    <thead>
                        <tr>
                            <th>Platform <span class="text-danger mandatory-star">*</span></th>
                            <th>Amount <span class="text-danger mandatory-star">*</span></th>
                            <th width="80">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in delivery_formset %}
                        <tr class="delivery-form">
                            {{ form.id }}
                            <td>{{ form.platform }}<div class="text-danger small">{{ form.platform.errors|join:", " }}</div></td>
                            <td>{{ form.amount }}<div class="text-danger small">{{ form.amount.errors|join:", " }}</div></td>
                            <td>{{ form.DELETE }}<button type="button" class="btn btn-sm btn-danger remove-row">❌</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <button type="button" class="btn btn-sm btn-primary" id="addDelivery">+ Add Delivery</button>

                <hr>
                <button type="submit" class="btn btn-success w-100">Save Daily Sale</button>
            </form>
        </div>
    </div>
</div>

<!-- ================= JAVASCRIPT ================= -->
<script>
document.addEventListener('DOMContentLoaded', function() {

    // ------------------ Helper: Update mandatory stars ------------------
    function updateMandatoryStars(tableSelector) {
        document.querySelectorAll(tableSelector + " tbody tr").forEach(row => {
            let inputs = row.querySelectorAll("input, select");
            let anyFilled = Array.from(inputs).some(input => input.value && input.value.trim() !== "");
            row.querySelectorAll(".mandatory-star").forEach(star => {
                star.style.visibility = anyFilled ? "visible" : "hidden";
            });
            // Remove 'required' attribute for empty rows
            inputs.forEach(input => {
                if (!anyFilled) input.removeAttribute('required');
            });
        });
    }

    // Initial update
    updateMandatoryStars('#mealTable');
    updateMandatoryStars('#deliveryTable');

    // Show stars on input
    document.addEventListener('input', function(e) {
        if (e.target.closest('#mealTable')) updateMandatoryStars('#mealTable');
        if (e.target.closest('#deliveryTable')) updateMandatoryStars('#deliveryTable');
    });

    // ------------------ Remove row ------------------
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-row')) {
            let row = e.target.closest('tr');
            let deleteCheckbox = row.querySelector("input[type='checkbox']");
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                row.style.display = "none";
            } else {
                row.remove();
            }
        }
    });

    // ------------------ Add Meal Row ------------------
    document.getElementById('addMeal').addEventListener('click', function() {
        let tableBody = document.querySelector('#mealTable tbody');
        let totalForms = document.querySelector('#id_items-TOTAL_FORMS');
        let formCount = parseInt(totalForms.value);

        let newRow = document.querySelector('.meal-form').cloneNode(true);
        newRow.innerHTML = newRow.innerHTML.replace(/items-\d+/g, 'items-' + formCount);

        // Reset input values
        newRow.querySelectorAll('input, select').forEach(input => {
            if (input.type !== "hidden" && input.type !== "checkbox") input.value = '';
            if (input.type === "checkbox") input.checked = false;
        });

        // Hide stars initially
        newRow.querySelectorAll(".mandatory-star").forEach(star => star.style.visibility = "hidden");

        tableBody.appendChild(newRow);
        totalForms.value = formCount + 1;
    });

    // ------------------ Add Delivery Row ------------------
    document.getElementById('addDelivery').addEventListener('click', function() {
        let tableBody = document.querySelector('#deliveryTable tbody');
        let totalForms = document.querySelector('#id_deliveries-TOTAL_FORMS');
        let formCount = parseInt(totalForms.value);

        let newRow = document.querySelector('.delivery-form').cloneNode(true);
        newRow.innerHTML = newRow.innerHTML.replace(/deliveries-\d+/g, 'deliveries-' + formCount);

        newRow.querySelectorAll('input, select').forEach(input => {
            if (input.type !== "hidden" && input.type !== "checkbox") input.value = '';
            if (input.type === "checkbox") input.checked = false;
        });

        newRow.querySelectorAll(".mandatory-star").forEach(star => star.style.visibility = "hidden");

        tableBody.appendChild(newRow);
        totalForms.value = formCount + 1;
    });

    // ------------------ Ignore empty rows on submit ------------------
    document.getElementById("salesForm").addEventListener("submit", function() {
        function cleanEmptyRows(tableSelector) {
            document.querySelectorAll(tableSelector + " tbody tr").forEach(row => {
                let inputs = row.querySelectorAll("input[type='text'], input[type='number'], select");
                let isEmpty = Array.from(inputs).every(input => !input.value || input.value.trim() === "");
                if (isEmpty) {
                    let deleteCheckbox = row.querySelector("input[type='checkbox']");
                    if (deleteCheckbox) deleteCheckbox.checked = true;
                }
            });
        }
        cleanEmptyRows("#mealTable");
        cleanEmptyRows("#deliveryTable");
    });

});
</script>

<style>
input[type="checkbox"][name$="DELETE"] {
    display: none;
}
</style>

{% endblock %}
