{% extends "base.html" %}
{% block 'content' %}

<div class="container-fluid px-4 mt-4">

    <!-- ================= HEADER ================= -->
    <div class="card shadow-sm mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h3 class="fw-bold mb-0">Delivery Performance Report</h3>
                {% comment %} <small class="text-muted">Track staff performance and delivery collection</small> {% endcomment %}
            </div>

            <button onclick="printReport()" class="btn btn-dark no-print">
                <i class="iconoir-printer"></i> Print
            </button>
            <a href="{% url 'export_report_page' 'delivery' %}?{{ request.GET.urlencode }}"
   class="btn btn-success no-print">
   Export
</a>
        </div>
    </div>


    <!-- ================= FILTERS ================= -->
    <div class="card shadow-sm mb-4 no-print">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">

                <!-- Order ID -->
                <div class="col-md-2">
                    <label class="form-label">Order ID</label>
                    <input type="text"
                           name="order_id"
                           value="{{ request.GET.order_id }}"
                           class="form-control"
                           placeholder="Search ID">
                </div>

                <!-- Staff -->
                <div class="col-md-2">
                    <label class="form-label">Staff</label>
                    <select name="staff" class="form-select">
                        <option value="">All Staff</option>
                        {% for staff in staff_list %}
                        <option value="{{ staff.id }}"
                            {% if request.GET.staff == staff.id|stringformat:"s" %}selected{% endif %}>
                            {{ staff.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Date -->
                <div class="col-md-2">
                    <label class="form-label">Date</label>
                    <input type="date"
                           name="date"
                           value="{{ selected_date }}"
                           class="form-control">
                </div>

                <!-- Buttons -->
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        Search
                    </button>
                </div>

                <div class="col-md-1">
                    <a href="{% url 'delivery_report' %}" class="btn btn-outline-danger w-100">
                        Clear
                    </a>
                </div>

            </form>
        </div>
    </div>


    <!-- ================= STAFF PERFORMANCE ================= -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white fw-semibold">
            Staff Performance Summary
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-bordered align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Staff Name</th>
                            <th class="text-center">Total Orders</th>
                            <th class="text-end">Total Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in performance %}
                        <tr>
                            <td>{{ row.staff__name }}</td>
                            <td class="text-center">{{ row.total_orders }}</td>
                            <td class="text-end fw-bold">{{ row.total_amount }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center text-muted py-3">
                                No performance data found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- ================= DETAILED DELIVERY ================= -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white fw-semibold">
            Detailed Delivery Records
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-bordered align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th>
                            <th>Order ID</th>
                            <th>Staff</th>
                            <th>Meal Type (Items)</th>
                            <th>Platform</th>
                            <th class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in deliveries %}
                        <tr>
                            <td>{{ d.sale.date|date:"d-m-Y" }}</td>
                            <td>{{ d.order_id }}</td>
                            <td>{{ d.staff.name }}</td>

                            <!-- Meal Type -->
                            <td>
                                {% regroup d.sale.items.all by meal_type as meal_groups %}
                                {% for group in meal_groups %}
                                    <strong>{{ group.grouper }}</strong>
                                    (
                                    {% for item in group.list %}
                                        {{ item.item_name }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                    )
                                    {% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </td>

                            <td>{{ d.platform }}</td>
                            <td class="text-end fw-bold">{{ d.amount }}</td>
                        </tr>

                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-3">
                                No delivery records found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- ================= GRAND TOTAL ================= -->
    <div class="card shadow-sm mt-4">
        <div class="card-body text-end">
            <h5 class="mb-0">
                Total Delivery Collection :
                <span class="text-success fw-bold fs-4">
                    {{ grand_total }}
                </span>
            </h5>
        </div>
    </div>

</div>


<!-- PRINT SCRIPT -->
<script>
function printReport() {
    window.print();
}
</script>

<style>
@media print {
    body { background: white !important; }
    .no-print { display: none !important; }
    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
    }
    table { font-size: 12px; }
    @page { size: A4; margin: 20mm; }
}
</style>

{% endblock %}