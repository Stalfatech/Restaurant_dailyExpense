{% extends "base.html" %}
{% load static %}
{% block 'content' %}

<div class="container mt-5">
<div class="card shadow-lg border-0 rounded-4">

<div class="card-header bg-dark text-white py-3">
<h4 class="mb-0">
<i class="bi bi-cash-stack me-2"></i> Add Salary
</h4>
</div>


<div class="card-body p-4">

<form method="POST">
{% csrf_token %}

<div class="row g-3">

<!-- Staff -->
<div class="col-md-6">
<label class="form-label fw-semibold">Staff Name *</label>
<select name="staff" id="staff_select" class="form-select" required>
<option value="">Select Staff</option>
{% for staff in staffs %}
<option value="{{ staff.id }}" data-salary-type="{{ staff.salary_type }}">
{{ staff.name }}
</option>
{% endfor %}
</select>
</div>

<!-- Salary Type -->
<div class="col-md-6">
<label class="form-label fw-semibold">Salary Type</label>
<input type="text" id="salary_type_display" class="form-control bg-light" readonly>
</div>

<!-- Month -->
<div class="col-md-6">
<label class="form-label fw-semibold">Salary Month *</label>
<select name="salary_month" id="salary_month" class="form-select" required>
<option value="">Select Month</option>
{% for m,v in month_choices %}
<option value="{{ m }}">{{ v }}</option>
{% endfor %}
</select>
</div>

<!-- Year -->
<div class="col-md-6">
<label class="form-label fw-semibold">Salary Year *</label>
<select name="salary_year" id="salary_year" class="form-select" required>
<option value="">Select Year</option>
{% for year in years %}
<option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
{% endfor %}
</select>
</div>

<!-- Salary Amount -->
<div class="col-md-6">
<label class="form-label fw-semibold">Salary Amount *</label>
<input type="number" step="0.01" name="salary_amount" id="salary_amount" class="form-control" required>
</div>

<!-- Need Advance -->
<div class="col-md-6">
<label class="form-label fw-semibold">Do you need advance of this month?</label>
<select name="need_advance" id="needAdvance" class="form-select" onchange="toggleAdvanceField()">
<option value="no" selected>No</option>
<option value="yes">Yes</option>
</select>
</div>

<!-- Salary Advance -->
<div class="col-md-6 d-none" id="advanceField">
<label class="form-label fw-semibold">Salary Advance</label>
<input type="number" step="0.01" name="salary_advance" id="salary_advance" value="0" class="form-control">
</div>

<!-- Paid Amount -->
<div class="col-md-6">
<label class="form-label fw-semibold">Paid Amount</label>
<input type="number" step="0.01" name="paid_amount" id="paid_amount" value="0" class="form-control">
</div>

<!-- Payment Date -->
<div class="col-md-6">
<label class="form-label fw-semibold">Payment Date *</label>
<input type="date" name="payment_date" class="form-control" required>
</div>

<!-- Payment Mode -->
<div class="col-md-6">
<label class="form-label fw-semibold">Payment Mode *</label>
<select name="payment_mode" class="form-select" required>
<option value="">Select Mode</option>
<option value="Cash">Cash</option>
<option value="Bank">Bank</option>
</select>
</div>

<!-- Need next month advance -->
<div class="col-md-6">
<label class="form-label fw-semibold">Need Next Month Advance?</label>
<select id="needNextAdvance" class="form-select" onchange="toggleNextMonthAdvance()">
<option value="no" selected>No</option>
<option value="yes">Yes</option>
</select>
</div>

<!-- Next month advance -->
<div class="col-md-6 d-none" id="nextMonthAdvanceField">
<label class="form-label fw-semibold">Next Month Advance Salary</label>
<input type="number" step="0.01" name="next_month_advance" id="next_month_advance" value="0" class="form-control">
</div>

<!-- Balance Preview -->
<div class="col-md-6">
<label class="form-label fw-semibold">Balance (Preview)</label>
<input type="text"
       id="balance_preview"
       name="balance_preview"
       class="form-control"
       readonly>
</div>

<!-- Previous balance -->
<div class="col-md-6">
<label class="form-label fw-semibold">Previous Month Balance</label>
<input type="text" id="previous_balance" class="form-control bg-light" readonly>
</div>

<!-- Already bought -->
<div class="col-md-6">
<label class="form-label fw-semibold">Already Bought Next Month Advance</label>
<input type="text" id="previous_next_month_advance" class="form-control bg-light" readonly>
</div>

</div>

<div class="text-end mt-4">
  <a href="{% url 'admin_salary_list' %}" class="btn btn-secondary me-2">
    <i class="bi bi-arrow-left me-1"></i> Back to List
  </a>
  <button type="submit" class="btn btn-dark px-4 rounded-3">
    <i class="bi bi-save me-1"></i> Save Salary
  </button>
</div>


</form>

</div>
</div>
</div>

{% comment %} 
<script>
document.addEventListener("DOMContentLoaded", function () {

    /* ===============================
       GET ELEMENTS
    ================================ */
    const salaryInput    = document.getElementById("salary_amount");
    const balancePreview = document.getElementById("balance_preview");
    
    const staffSelect        = document.getElementById("staff_select");
    const salaryTypeDisplay  = document.getElementById("salary_type_display");
    const monthSelect       = document.getElementById("salary_month");
    const yearSelect        = document.getElementById("salary_year");

    const prevBalanceEl     = document.getElementById("previous_balance");
    const prevAdvanceEl     = document.getElementById("previous_next_month_advance");

    const advanceInput      = document.getElementById("salary_advance");
    const nextMonthAdvance  = document.getElementById("next_month_advance");

    /* ===============================
       BALANCE CALCULATION (NEW FORMULA)
    ================================ */
    function calculateBalance() {
        let salary = parseFloat(salaryInput.value) || 0;
        let prevBalance = parseFloat(prevBalanceEl?.value) || 0;
        let prevAdvance = parseFloat(prevAdvanceEl?.value) || 0;
        let nextAdvance = parseFloat(nextMonthAdvance?.value) || 0;
        let currentAdvance = parseFloat(advanceInput?.value) || 0;

        // New formula: balance = salary - (previous balance + next month advance)
        let finalBalance = salary - (prevBalance + nextAdvance);
        if (finalBalance < 0) finalBalance = 0;

        balancePreview.value = finalBalance.toFixed(2);
    }

    /* ===============================
       EVENT LISTENERS
    ================================ */

    [salaryInput, advanceInput, nextMonthAdvance].forEach(input => {
        if(input) input.addEventListener("input", calculateBalance);
    });

    [staffSelect, monthSelect, yearSelect].forEach(select => {
        if(select) select.addEventListener("change", fetchPreviousSalaryData);
    });
    if (staffSelect) {
        staffSelect.addEventListener("change", function() {
            const selected = this.options[this.selectedIndex];
            if (salaryTypeDisplay) {
                salaryTypeDisplay.value = selected.getAttribute("data-salary-type") || "";
            }
            fetchPreviousSalaryData();
        });
    }

    /* ===============================
       FETCH PREVIOUS SALARY DATA
    ================================ */
    function fetchPreviousSalaryData() {
        const staff_id = staffSelect.value;
        const month = monthSelect.value;
        const year = yearSelect.value;
        const salary = salaryInput.value || 0;

        if (!staff_id || !month || !year) return;

        fetch(`/get_previous_salary_data/?staff_id=${staff_id}&salary_month=${month}&salary_year=${year}&salary_amount=${salary}`)
        .then(response => response.json())
        .then(data => {
            prevBalanceEl.value = data.previous_balance || "0.00";
            prevAdvanceEl.value = data.previous_next_month_advance || "0.00";

            // Recalculate balance using new formula
            calculateBalance();
        })
        .catch(error => console.error(error));
    }

    /* ===============================
       TOGGLE ADVANCE FIELDS
    ================================ */
    window.toggleAdvanceField = function() {
        const dropdown = document.getElementById("needAdvance");
        const field = document.getElementById("advanceField");
        if (!dropdown || !field || !advanceInput) return;

        if(dropdown.value === "yes") {
            field.classList.remove("d-none");
            advanceInput.focus();
        } else {
            field.classList.add("d-none");
            advanceInput.value = 0;
            calculateBalance();
        }
    };

    window.toggleNextMonthAdvance = function() {
        const dropdown = document.getElementById("needNextAdvance");
        const field = document.getElementById("nextMonthAdvanceField");
        if (!dropdown || !field || !nextMonthAdvance) return;

        if(dropdown.value === "yes") {
            field.classList.remove("d-none");
            nextMonthAdvance.focus();
        } else {
            field.classList.add("d-none");
            nextMonthAdvance.value = 0;
            calculateBalance();
        }
    };

    /* ===============================
       INITIAL LOAD
    ================================ */
    calculateBalance();
});
</script> {% endcomment %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    const salaryInput    = document.getElementById("salary_amount");
    const balancePreview = document.getElementById("balance_preview");

    const staffSelect       = document.getElementById("staff_select");
    const salaryTypeDisplay = document.getElementById("salary_type_display");
    const monthSelect       = document.getElementById("salary_month");
    const yearSelect        = document.getElementById("salary_year");

    const prevMonthSalaryEl = document.getElementById("previous_balance");
    const advanceTokenEl    = document.getElementById("previous_next_month_advance");

    const advanceInput     = document.getElementById("salary_advance");
    const nextMonthAdvance = document.getElementById("next_month_advance");
    const paidInput        = document.getElementById("paid_amount");

    /* -------------------
       CALCULATE BALANCE
    ------------------- */
    function calculateBalance() {
        const currentSalary  = parseFloat(salaryInput.value) || 0;
        const previousSalary = parseFloat(prevMonthSalaryEl.value) || 0;
        const advanceToken   = parseFloat(advanceTokenEl.value) || 0;
        const paidAmount     = parseFloat(paidInput.value) || 0;

        let finalBalance = (currentSalary + previousSalary) - paidAmount - advanceToken;
        if (finalBalance < 0) finalBalance = 0;

        balancePreview.value = finalBalance.toFixed(2);
    }

    /* -------------------
       FETCH PREVIOUS SALARY
    ------------------- */
    function fetchPreviousSalaryData() {
    const staff_id = staffSelect.value;
    const month    = monthSelect.value;
    const year     = yearSelect.value;
    const salary   = salaryInput.value || 0;
    const paid     = paidInput.value || 0;

    if (!staff_id || !month || !year) return;

    fetch(`/get_previous_salary_data/?staff_id=${staff_id}&salary_month=${month}&salary_year=${year}&salary_amount=${salary}&paid_amount=${paid}`)
        .then(r => r.json())
        .then(data => {
            prevMonthSalaryEl.value = data.previous_month_salary ?? "0.00";
            advanceTokenEl.value    = data.advance_token ?? "0.00";
            document.getElementById("previous_balance").value = data.previous_balance ?? "0.00"; // new
            balancePreview.value = data.balance_preview ?? "0.00";
        })
        .catch(err => console.error(err));
}
    /* -------------------
       EVENTS
    ------------------- */
    salaryInput.addEventListener("input", calculateBalance);
    paidInput.addEventListener("input", calculateBalance);
    advanceInput.addEventListener("input", calculateBalance);
    nextMonthAdvance.addEventListener("input", calculateBalance);

    [staffSelect, monthSelect, yearSelect].forEach(el => {
        if (el) el.addEventListener("change", fetchPreviousSalaryData);
    });

    staffSelect.addEventListener("change", function () {
        const selected = this.options[this.selectedIndex];
        salaryTypeDisplay.value = selected.getAttribute("data-salary-type") || "";
        fetchPreviousSalaryData();
    });

    /* -------------------
       TOGGLE ADVANCE FIELDS
    ------------------- */
    window.toggleAdvanceField = function() {
        const dropdown = document.getElementById("needAdvance");
        const field = document.getElementById("advanceField");
        if (!dropdown || !field) return;

        if (dropdown.value === "yes") {
            field.classList.remove("d-none");
            advanceInput.focus();
        } else {
            field.classList.add("d-none");
            advanceInput.value = 0;
            calculateBalance();
        }
    };

    window.toggleNextMonthAdvance = function() {
        const dropdown = document.getElementById("needNextAdvance");
        const field = document.getElementById("nextMonthAdvanceField");
        if (!dropdown || !field) return;

        if (dropdown.value === "yes") {
            field.classList.remove("d-none");
            nextMonthAdvance.focus();
        } else {
            field.classList.add("d-none");
            nextMonthAdvance.value = 0;
            calculateBalance();
        }
    };

    /* -------------------
       INITIAL LOAD
    ------------------- */
    // Trigger fetch if staff/month/year are pre-selected
    fetchPreviousSalaryData();
    calculateBalance();

});
</script>
{% endblock %}


